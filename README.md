# Документация OmniSearch

---
Проект предоставляет решение для извлечения и суммаризации ключевой информации из видео, используя мультимодальные данные: распознанную речь (ASR), визуально распознаваний текст (OCR) и описание видео (captioning). Решение позволяет индексировать видео и производить поиск релеватного контента по пользовательским запросам.

---

## Бизнес-логика решения

**Основные сценарии использования:**

1. **Загрузка и обработка видео:** Сервис принимает на вход видео извлекает информацию с помощью OCR, ASR, и Captioning микросервисов. Затем, с помощью LLM данные суммаризируются в емкое текстовое представление видео.
   
2. **Индексация:** Суммаризованное видео кодируется и вносится в векторную базу данных.

3. **Векторный поиск:** Пользовательский ввод кодируется и служит запросом в векторную базу данных.

---

## 3. Описание технической реализации

**Логика бэкенда:**

- **API:** Использует FastAPI для создания веб-сервиса. Основные эндпоинты включают добавление задач на обработку видео, получение статуса задач, и выполнение поиска по суммаризациям.

- **STT (Speech-to-Text):** Модуль `stt.py` отвечает за преобразование речи в текст.
  - `convert(path, new_rate) -> np.ndarray`: Конвертирует аудиофайл в формат, подходящий для обработки.
  - `stt_request(audio: np.ndarray, server_: str) -> str`: Выполняет запрос к серверу для распознавания речи.
  - `process_video_stt(local_path_video: str) -> str`: Извлекает аудиотрек из видео и обрабатывает его для получения текста.

- **OCR (Optical Character Recognition):** Модуль `text_extractor.py` извлекает текст из видео.
  - `extract_text(video_link: str, sample_rate: float, confidence_threshold: float, max_image_size: int, max_frames: int, batch_size: int) -> list[str]`: Извлекает текст из видео, используя EasyOCR.

- **Суммаризация:** Модуль `api.py` объединяет данные из OCR, ASR и описания видео для создания суммаризации с помощью вызова языковой модели.
  - `summary_modalities(asr, ocr, caption, call_llm, model_path) -> str`: Создает суммаризацию на основе текста из ASR, OCR и описания видео, вызывая языковую модель.
  - `call_vllm_api(text, model, url, max_tokens, temperature) -> str`: Вызывает API языковой модели для генерации текста на основе переданного запроса.

- **Обработка видео:** В модуле `video_capture.py` реализована функциональность для обработки и извлечения кадров из видео.
  - `video_capture(filepath)`: Контекстный менеджер для захвата видео с помощью OpenCV.

**Выборка для обучения:** В решении используется предварительно индексированная база данных из 13 тысяч репрезентативных представителей кластеров.

---

## 4. Описание выбранного стэка технологий

**Технологический стек:**

- **Язык программирования:** Python.
- **Веб-фреймворк:** FastAPI для создания RESTful API.
- **Библиотеки для обработки данных:** `pandas`, `faiss`, `numpy`.
- **Модель для суммаризации:** `SentenceTransformer` для создания векторных представлений.
- **Клиент API:** `requests` для взаимодействия с языковой моделью.
- **Дополнительные:** `uvicorn` для запуска FastAPI, `logging` для логирования, `dataclasses` для упрощения работы с данными, `librosa` для обработки аудио, `scipy` для ресемплинга аудио, `grpc` для взаимодействия с сервером распознавания речи.

**Причины выбора:**

- **Python** - гибкий язык с богатой экосистемой библиотек, подходящий для задач машинного обучения и разработки API.
- **FastAPI** - высокопроизводительный веб-фреймворк с простой интеграцией и поддержкой асинхронного программирования.
- **SentenceTransformer** - мощный инструмент для создания векторных представлений текстов, подходящий для многомодальной обработки и поиска.
- **librosa** и **scipy** - инструменты для обработки аудио, обеспечивающие гибкость и точность в ресемплинге и анализе звуковых данных.

---

## 5. Модель данных (тут не уверен)

**Описание схемы данных:**

| Поле           | Тип         | Описание                                |
|----------------|-------------|-----------------------------------------|
| `id_`          | int         | Уникальный идентификатор задачи         |
| `execution_time` | int       | Время выполнения задачи                 |
| `video_link`   | str         | Ссылка на видео                         |
| `caption`      | str         | Описание видео                          |
| `error`        | str         | Ошибка, если она произошла              |
| `ocr`          | str         | Текст, извлеченный из OCR               |
| `llava`        | str         | Описание видео                          |
| `omnisummary`  | str         | Суммаризация видео                      |
| `asr`          | str         | Текст, извлеченный из ASR               |



## 6. Инструкция по установке и развертыванию

TODO: merge
